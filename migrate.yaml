steps:
  - name: 'node:20'
    entrypoint: 'bash'
    args:
    - '-c'
    - |
      # 1. Install dependencies
      npm ci

      # 2. Download Cloud SQL Proxy
      curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.8.0/cloud-sql-proxy.linux.amd64
      chmod +x cloud-sql-proxy

      # 3. Start Proxy in background
      ./cloud-sql-proxy royal-lips:europe-west3:royal-lips-db-small --port 5433 &
      PID=$$!
      echo "Waiting for proxy to start..."
      sleep 5

      # 4. Run Migration
      export DATABASE_URL="postgresql://postgres:royallips1220%40%23@127.0.0.1:5433/royal-lips-database?sslmode=disable"
      npx prisma db push --accept-data-loss

      # 5. Cleanup
      kill $$PID

options:
  logging: CLOUD_LOGGING_ONLY
